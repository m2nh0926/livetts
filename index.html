<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LiveSTT</title>
<style>
:root{--bg:#0a0a0f;--bg2:#12121a;--card:#1a1a28;--cardH:#222233;--ac:#7c6cf0;--ac2:#a29bfe;--acG:rgba(108,92,231,.3);--tx:#eeeef5;--tx2:#8888aa;--dim:#555577;--ok:#00cec9;--warn:#fdcb6e;--err:#ff6b6b;--red:#ff4757;--bdr:rgba(255,255,255,.06);--r:14px;--rs:10px}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,'Noto Sans KR',sans-serif;background:var(--bg);color:var(--tx);min-height:100vh}
body::before{content:'';position:fixed;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(ellipse at 20% 50%,rgba(108,92,231,.07) 0%,transparent 50%),radial-gradient(ellipse at 80% 20%,rgba(0,206,201,.04) 0%,transparent 50%);z-index:0;pointer-events:none}
.app{position:relative;z-index:1;max-width:700px;margin:0 auto;padding:16px}

.hdr{display:flex;align-items:center;justify-content:space-between;padding:12px 0 20px;border-bottom:1px solid var(--bdr);margin-bottom:20px}
.hdr-l{display:flex;align-items:center;gap:12px}
.logo{width:40px;height:40px;border-radius:11px;background:linear-gradient(135deg,var(--ac),var(--ac2));display:flex;align-items:center;justify-content:center;font-size:20px;box-shadow:0 4px 16px var(--acG)}
.logo-t{font-weight:800;font-size:20px;background:linear-gradient(135deg,var(--tx),var(--ac2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.logo-s{font-size:10px;color:var(--dim);letter-spacing:1.5px;text-transform:uppercase}
.badge{display:flex;align-items:center;gap:7px;padding:7px 14px;border-radius:50px;font-size:12px;font-weight:600;border:1px solid var(--bdr);background:var(--bg2);color:var(--dim);transition:all .3s}
.badge.on{color:var(--ok);border-color:rgba(0,206,201,.3);background:rgba(0,206,201,.08)}
.dot{width:7px;height:7px;border-radius:50%;background:currentColor}
.badge.on .dot{animation:pulse 1.5s infinite}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.4;transform:scale(1.4)}}

.card{background:var(--card);border:1px solid var(--bdr);border-radius:var(--r);padding:16px;margin-bottom:12px}
.card-t{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:var(--dim);margin-bottom:14px;display:flex;align-items:center;gap:6px}

/* ë“€ì–¼ ëª¨ë“œ íƒ­ */
.tab-bar{display:flex;gap:4px;margin-bottom:14px}
.tab-btn{flex:1;padding:10px 14px;border:1px solid var(--bdr);border-radius:var(--rs);background:var(--bg);color:var(--dim);font-size:13px;font-weight:700;cursor:pointer;font-family:inherit;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:6px}
.tab-btn.active{background:rgba(108,92,231,.12);color:var(--ac2);border-color:rgba(108,92,231,.35)}
.tab-btn:hover:not(.active){border-color:var(--dim);color:var(--tx2)}
.tab-content{display:none}
.tab-content.active{display:block}

.yt-row{display:flex;gap:8px}
.yt-in{flex:1;padding:12px 14px;background:var(--bg);border:1px solid var(--bdr);border-radius:var(--rs);color:var(--tx);font-size:14px;font-family:inherit;outline:none;transition:border .2s}
.yt-in:focus{border-color:var(--ac)}
.yt-in::placeholder{color:var(--dim)}

.btn{width:100%;padding:13px;border:none;border-radius:var(--rs);font-family:inherit;font-weight:700;font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:all .2s}
.btn-go{background:linear-gradient(135deg,var(--ac),#8b7cf8);color:white;margin-top:12px;box-shadow:0 4px 16px var(--acG)}
.btn-go:hover{box-shadow:0 6px 24px rgba(108,92,231,.4)}
.btn-go:disabled{opacity:.4;box-shadow:none;cursor:not-allowed}
.btn-stop{background:rgba(255,107,107,.12);color:var(--err);border:1px solid rgba(255,107,107,.2);margin-top:8px}
.btn-stop:disabled{opacity:.3;cursor:not-allowed}

.desc{font-size:12px;color:var(--dim);line-height:1.6;padding:10px;background:var(--bg);border-radius:var(--rs);margin-top:12px}

.wave{height:42px;background:var(--bg);border-radius:var(--rs);display:flex;align-items:center;justify-content:center;gap:3px;padding:0 12px;margin-bottom:12px}
.wave .bar{width:3px;height:8px;background:var(--ac);border-radius:2px;opacity:.3}
.wave.on .bar{animation:w .8s ease-in-out infinite;opacity:1}
@keyframes w{0%,100%{height:8px;opacity:.3}50%{height:30px;opacity:1}}
.wave.on .bar:nth-child(1){animation-delay:0s}.wave.on .bar:nth-child(2){animation-delay:.1s}.wave.on .bar:nth-child(3){animation-delay:.2s}.wave.on .bar:nth-child(4){animation-delay:.15s}.wave.on .bar:nth-child(5){animation-delay:.25s}.wave.on .bar:nth-child(6){animation-delay:.05s}.wave.on .bar:nth-child(7){animation-delay:.3s}.wave.on .bar:nth-child(8){animation-delay:.12s}.wave.on .bar:nth-child(9){animation-delay:.22s}.wave.on .bar:nth-child(10){animation-delay:.07s}.wave.on .bar:nth-child(11){animation-delay:.18s}.wave.on .bar:nth-child(12){animation-delay:.27s}

.stats{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px}
.stat{background:var(--bg);border-radius:var(--rs);padding:12px;text-align:center}
.stat-v{font-size:20px;font-weight:800;color:var(--ac2);font-variant-numeric:tabular-nums}
.stat-l{font-size:10px;color:var(--dim);margin-top:4px}

.tx-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.tx-acts{display:flex;gap:6px}
.tx-acts button{padding:7px 12px;border:1px solid var(--bdr);border-radius:8px;background:var(--bg);color:var(--tx2);font-size:11px;font-weight:600;cursor:pointer;font-family:inherit;transition:all .2s}
.tx-acts button:hover{border-color:var(--ac);color:var(--ac2)}
.tx-box{min-height:30vh;max-height:50vh;overflow-y:auto;display:flex;flex-direction:column;gap:2px}
.tx-box::-webkit-scrollbar{width:5px}
.tx-box::-webkit-scrollbar-thumb{background:var(--bdr);border-radius:3px}
.tx-line{display:flex;gap:10px;padding:10px 12px;border-radius:var(--rs);animation:fadeUp .3s}
.tx-line:hover{background:var(--cardH)}
.tx-line.status{opacity:.6}
@keyframes fadeUp{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.tx-time{font-size:10px;color:var(--dim);min-width:48px;padding-top:3px;font-variant-numeric:tabular-nums}
.tx-lang{font-size:9px;padding:2px 6px;border-radius:4px;font-weight:700;min-width:24px;text-align:center;margin-top:3px}
.tx-lang.ko{background:rgba(0,206,201,.15);color:var(--ok)}
.tx-lang.en{background:rgba(253,203,110,.15);color:var(--warn)}
.tx-text{font-size:14px;line-height:1.7;flex:1;word-break:keep-all}
.tx-text.interim{color:var(--tx2);font-style:italic;opacity:.5}
.tx-translated{font-size:13px;color:var(--ok);padding:4px 0 0 60px;opacity:.85;line-height:1.6}

.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:25vh;gap:10px;color:var(--dim)}
.empty-ic{font-size:48px;opacity:.3}
.empty-t{font-size:16px;font-weight:600;color:var(--tx2)}
.empty-d{font-size:12px;text-align:center;line-height:1.6;max-width:300px}

.viewer-link{display:flex;align-items:center;gap:8px;padding:10px 14px;background:var(--bg);border:1px dashed rgba(108,92,231,.3);border-radius:var(--rs);margin-top:12px;cursor:pointer;transition:all .2s}
.viewer-link:hover{border-color:var(--ac);background:rgba(108,92,231,.05)}
.viewer-link .icon{font-size:18px}
.viewer-link .info{flex:1}
.viewer-link .label{font-size:12px;font-weight:600;color:var(--ac2)}
.viewer-link .url{font-size:11px;color:var(--dim);font-family:monospace}

.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(60px);background:var(--card);border:1px solid var(--bdr);color:var(--tx);padding:12px 20px;border-radius:12px;font-size:13px;font-weight:500;z-index:999;opacity:0;transition:all .3s;pointer-events:none;box-shadow:0 8px 30px rgba(0,0,0,.4)}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

.tx-acts .btn-sum{background:rgba(108,92,231,.12);color:var(--ac2);border-color:rgba(108,92,231,.25)}

/* ìš”ì•½ ëª¨ë‹¬ (Ollama ë¯¸íŒ… ìš”ì•½) */
.sum-ov{position:fixed;inset:0;background:rgba(0,0,0,.65);backdrop-filter:blur(6px);z-index:900;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .3s}
.sum-ov.open{opacity:1;pointer-events:auto}
.sum-modal{background:var(--card);border:1px solid var(--bdr);border-radius:18px;width:640px;max-width:96vw;max-height:82vh;display:flex;flex-direction:column;transform:translateY(20px) scale(.97);transition:transform .35s cubic-bezier(.22,1,.36,1);box-shadow:0 20px 60px rgba(0,0,0,.5)}
.sum-ov.open .sum-modal{transform:translateY(0) scale(1)}
.sum-hdr{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;border-bottom:1px solid var(--bdr)}
.sum-hdr h2{font-size:16px;font-weight:700}
.sum-x{width:30px;height:30px;border-radius:8px;border:1px solid var(--bdr);background:var(--bg);color:var(--tx2);font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.sum-body{padding:20px;overflow-y:auto;flex:1;line-height:1.8;font-size:14px}
.sum-body h3{font-size:15px;font-weight:700;color:var(--ac2);margin:16px 0 8px}
.sum-body h3:first-child{margin-top:0}
.sum-body ul{margin:0 0 8px 16px}
.sum-body li{margin-bottom:4px}
.sum-body p{margin-bottom:8px}
.sum-ft{padding:14px 20px;border-top:1px solid var(--bdr);display:flex;gap:8px;justify-content:flex-end}
.sum-ft button{padding:10px 16px;border:1px solid var(--bdr);border-radius:var(--rs);background:var(--bg);color:var(--tx2);font-size:12px;font-weight:600;cursor:pointer;font-family:inherit}
.sum-loading{text-align:center;padding:40px 20px;color:var(--dim)}
.sum-loading .spinner{width:32px;height:32px;border:3px solid var(--bdr);border-top-color:var(--ac);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 12px}
@keyframes spin{to{transform:rotate(360deg)}}
.sum-error{text-align:center;padding:30px 20px;color:var(--err);font-size:13px;line-height:1.6}
.sum-empty{text-align:center;padding:30px 20px;color:var(--dim);font-size:13px;line-height:1.6}
.sum-empty span{font-size:32px;display:block;margin-bottom:10px;opacity:.3}
</style>
</head>
<body>
<div class="app">
  <div class="hdr">
    <div class="hdr-l">
      <div class="logo">ğŸ¤</div>
      <div><div class="logo-t">LiveSTT</div><div class="logo-s">Whisper AI + Web Speech</div></div>
    </div>
    <div class="badge" id="badge"><div class="dot"></div><span id="badgeTx">ëŒ€ê¸° ì¤‘</span></div>
  </div>

  <!-- ì…ë ¥ ëª¨ë“œ ì¹´ë“œ: ë“€ì–¼ íƒ­ -->
  <div class="card">
    <div class="tab-bar">
      <button class="tab-btn active" onclick="switchTab('yt')" id="tabYt">ğŸ“º YouTube</button>
      <button class="tab-btn" onclick="switchTab('tab')" id="tabTab">ğŸ–¥ï¸ íƒ­ ì˜¤ë””ì˜¤ ê³µìœ </button>
    </div>

    <!-- íƒ­1: YouTube ëª¨ë“œ -->
    <div class="tab-content active" id="panelYt">
      <div class="yt-row">
        <input type="text" class="yt-in" id="urlInput" placeholder="YouTube ì˜ìƒ ë˜ëŠ” ë¼ì´ë¸Œ URL ë¶™ì—¬ë„£ê¸°...">
      </div>
      <button class="btn btn-go" id="ytGoBtn" onclick="startYT()">â–¶ ì¸ì‹ ì‹œì‘</button>
      <button class="btn btn-stop" id="ytStopBtn" onclick="stopYT()" disabled>â¹ ì¤‘ì§€</button>
      <div class="desc">ğŸ’¡ YouTube URLì„ ì…ë ¥í•˜ë©´ ì„œë²„ê°€ ì§ì ‘ ì˜¤ë””ì˜¤ë¥¼ ì¶”ì¶œí•˜ê³  Whisper AIë¡œ ì¸ì‹í•©ë‹ˆë‹¤. ë§ˆì´í¬ ë¶ˆí•„ìš”, ë¼ì´ë¸Œ/ì¼ë°˜ ì˜ìƒ ëª¨ë‘ ì§€ì›.</div>
    </div>

    <!-- íƒ­2: íƒ­ ì˜¤ë””ì˜¤ + ë§ˆì´í¬ ìŠ¤í…Œë ˆì˜¤ ë¯¹ìŠ¤ -->
    <div class="tab-content" id="panelTab">
      <button class="btn btn-go" id="tabGoBtn" onclick="startTabAudio()">ğŸ–¥ï¸ íƒ­ ì˜¤ë””ì˜¤ ê³µìœ  ì‹œì‘</button>
      <button class="btn btn-stop" id="tabStopBtn" onclick="stopTabAudio()" disabled>â¹ ì¤‘ì§€</button>
      <div class="desc">ğŸ’¡ ë¸Œë¼ìš°ì € íƒ­ì˜ ì˜¤ë””ì˜¤ì™€ ë§ˆì´í¬ë¥¼ ë™ì‹œì— ìº¡ì²˜(ìŠ¤í…Œë ˆì˜¤ ë¯¹ìŠ¤)í•˜ì—¬ Whisper AIë¡œ ì¸ì‹í•©ë‹ˆë‹¤.<br>Zoom, Google Meet ë“± ë¸Œë¼ìš°ì € íƒ­ì—ì„œ ì§„í–‰ ì¤‘ì¸ í†µí™”ì— ìµœì í™”.<br>âš ï¸ ê³µìœ  íŒì—…ì—ì„œ <b>"íƒ­ ì˜¤ë””ì˜¤ë„ ê³µìœ "</b> ì²´í¬ë¥¼ ê¼­ í™•ì¸í•˜ì„¸ìš”.</div>
    </div>

    <!-- ê³µí†µ: ë·°ì–´ ë§í¬ -->
    <div class="viewer-link" onclick="window.open(location.origin+'/viewer.html','_blank')">
      <div class="icon">ğŸ“¡</div>
      <div class="info">
        <div class="label">ë·°ì–´ í˜ì´ì§€ ì—´ê¸° (ë³„ë„ íƒ­ì—ì„œ ìë§‰ë§Œ ë³´ê¸°)</div>
        <div class="url" id="viewerUrl">-</div>
      </div>
    </div>
  </div>

  <!-- íŒŒí˜• + í†µê³„ -->
  <div class="card">
    <div class="wave" id="wave"><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div></div>
    <div class="stats">
      <div class="stat"><div class="stat-v" id="sL">0</div><div class="stat-l">ë¬¸ì¥</div></div>
      <div class="stat"><div class="stat-v" id="sV">0</div><div class="stat-l">ë·°ì–´</div></div>
    </div>
  </div>

  <!-- ì‹¤ì‹œê°„ ìë§‰ -->
  <div class="card">
    <div class="tx-hdr">
      <div class="card-t" style="margin:0">ğŸ“ ì‹¤ì‹œê°„ ìë§‰</div>
      <div class="tx-acts">
        <button class="btn-sum" onclick="openSum()">ğŸ“Š ìš”ì•½</button>
        <button onclick="copyTx()">ğŸ“‹ ë³µì‚¬</button>
        <button onclick="dlTx()">ğŸ’¾ ì €ì¥</button>
        <button onclick="clearTx()">ğŸ—‘ ì´ˆê¸°í™”</button>
      </div>
    </div>
    <div class="tx-box" id="txBox">
      <div class="empty" id="emptyEl">
        <div class="empty-ic">ğŸ¤</div>
        <div class="empty-t">ì¸ì‹ ëª¨ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
        <div class="empty-d">YouTube URL ì…ë ¥ ë˜ëŠ” ë§ˆì´í¬ ì¸ì‹ì„ ì‹œì‘í•˜ë©´<br>ì‹¤ì‹œê°„ ìë§‰ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
      </div>
    </div>
  </div>
</div>
<div class="toast" id="toast"></div>

<!-- ìš”ì•½ ëª¨ë‹¬ (Ollama ë¯¸íŒ… ìš”ì•½) -->
<div class="sum-ov" id="sumOv" onclick="if(event.target===this)closeSum()">
  <div class="sum-modal">
    <div class="sum-hdr"><h2>ğŸ“Š ë¯¸íŒ… ìš”ì•½</h2><button class="sum-x" onclick="closeSum()">&times;</button></div>
    <div class="sum-body" id="sumBody"></div>
    <div class="sum-ft"><button onclick="copySum()">ğŸ“‹ ìš”ì•½ ë³µì‚¬</button><button onclick="closeSum()">ë‹«ê¸°</button></div>
  </div>
</div>

<script>
// ========================================
// ì „ì—­ ìƒíƒœ
// ========================================
var ws = null;              // ë·°ì–´ìš© WebSocket (ìë§‰ ìˆ˜ì‹ )
var audioSenderWs = null;   // íƒ­ ì˜¤ë””ì˜¤ sender WebSocket
var tabRecorder = null;     // MediaRecorder ì¸ìŠ¤í„´ìŠ¤
var tabAudioCtx = null;     // AudioContext (ìŠ¤í…Œë ˆì˜¤ ë¯¹ìŠ¤ìš©)
var tabDisplayStream = null;// getDisplayMedia ìŠ¤íŠ¸ë¦¼
var tabMicStream = null;    // getUserMedia ë§ˆì´í¬ ìŠ¤íŠ¸ë¦¼
var nL = 0;
var activeMode = null;      // 'yt' | 'tab' | null
var sumCache = '';
var interimEl = null;

// ========================================
// ì´ˆê¸°í™”
// ========================================
(function init() {
  document.getElementById('viewerUrl').textContent = location.origin + '/viewer.html';
  // YouTube URL ì…ë ¥ì°½ ì—”í„° í‚¤
  document.getElementById('urlInput').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') startYT();
  });
  connectViewerWS();
  setInterval(pollStatus, 5000);
})();

// ========================================
// íƒ­ ì „í™˜
// ========================================
function switchTab(tab) {
  if (activeMode) {
    toast('âš ï¸ ì¸ì‹ ì¤‘ì—ëŠ” íƒ­ì„ ì „í™˜í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì¤‘ì§€í•˜ì„¸ìš”.');
    return;
  }
  document.getElementById('tabYt').classList.toggle('active', tab === 'yt');
  document.getElementById('tabTab').classList.toggle('active', tab === 'tab');
  document.getElementById('panelYt').classList.toggle('active', tab === 'yt');
  document.getElementById('panelTab').classList.toggle('active', tab === 'tab');
}

// ========================================
// ë·°ì–´ WebSocket (ìë§‰ ìˆ˜ì‹ ìš© â€” ë‘ ëª¨ë“œ ê³µí†µ)
// ========================================
function connectViewerWS() {
  var proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  ws = new WebSocket(proto + '//' + location.host + '/ws?role=viewer');
  ws.onmessage = function(ev) {
    try {
      var d = JSON.parse(ev.data);
      addLine(d);
    } catch(e) {}
  };
  ws.onclose = function() { setTimeout(connectViewerWS, 3000); };
}

// ========================================
// ìë§‰ í•œ ì¤„ ì¶”ê°€ (í™”ë©´ì— í‘œì‹œ)
// ========================================
function addLine(d) {
  var box = document.getElementById('txBox');
  var em = document.getElementById('emptyEl');
  if (em) em.style.display = 'none';

  // ë§ˆì´í¬ ëª¨ë“œ ì¤‘ê°„ ê²°ê³¼ ì²˜ë¦¬
  if (d.type === 'interim') {
    if (!interimEl) {
      interimEl = document.createElement('div');
      interimEl.className = 'tx-line';
      interimEl.innerHTML =
        '<div class="tx-time">' + esc(d.time || '') + '</div>' +
        '<div class="tx-lang ' + (d.lang || '') + '">' + (d.lang ? d.lang.toUpperCase() : '') + '</div>' +
        '<div class="tx-text interim">' + esc(d.text || '') + '</div>';
      box.appendChild(interimEl);
    } else {
      interimEl.querySelector('.tx-text').textContent = d.text || '';
    }
    box.scrollTop = box.scrollHeight;
    return;
  }

  // í™•ì • ê²°ê³¼ â€” ì¤‘ê°„ ê²°ê³¼ ì œê±°
  if (interimEl) { interimEl.remove(); interimEl = null; }

  var div = document.createElement('div');
  div.className = 'tx-line' + (d.type === 'status' ? ' status' : '');
  var langCls = (d.lang === 'ko') ? 'ko' : (d.lang === 'en' ? 'en' : '');
  div.innerHTML =
    '<div class="tx-time">' + esc(d.time || '') + '</div>' +
    '<div class="tx-lang ' + langCls + '">' + (d.lang ? d.lang.toUpperCase() : '') + '</div>' +
    '<div class="tx-text">' + esc(d.text || '') + '</div>';
  if (d.translated) {
    div.innerHTML += '<div class="tx-translated">ğŸ‡°ğŸ‡· ' + esc(d.translated) + '</div>';
  }
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;

  if (d.type === 'final') {
    nL++;
    document.getElementById('sL').textContent = nL;
  }
}

function esc(s) { var d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

// ========================================
// ëª¨ë“œ 1: YouTube (ì„œë²„ Whisper AI)
// ========================================
async function startYT() {
  var url = document.getElementById('urlInput').value.trim();
  if (!url) { toast('YouTube URLì„ ì…ë ¥í•˜ì„¸ìš”'); return; }
  if (activeMode) { toast('âš ï¸ ì´ë¯¸ ì¸ì‹ ì¤‘ì…ë‹ˆë‹¤'); return; }

  document.getElementById('ytGoBtn').disabled = true;
  document.getElementById('ytStopBtn').disabled = false;

  try {
    var resp = await fetch('/api/start', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ url: url }),
    });
    if (resp.ok) {
      setRunning('yt');
      toast('ğŸ¤ YouTube ì¸ì‹ ì‹œì‘!');
    } else {
      var err = await resp.json();
      toast('âŒ ' + (err.error || 'ì˜¤ë¥˜'));
      document.getElementById('ytGoBtn').disabled = false;
      document.getElementById('ytStopBtn').disabled = true;
    }
  } catch(e) {
    toast('âŒ ì„œë²„ ì—°ê²° ì‹¤íŒ¨');
    document.getElementById('ytGoBtn').disabled = false;
    document.getElementById('ytStopBtn').disabled = true;
  }
}

async function stopYT() {
  try {
    await fetch('/api/stop', { method: 'POST' });
  } catch(e) {}
  setRunning(null);
  toast('â¹ YouTube ì¸ì‹ ì¤‘ì§€ë¨');
}

// ========================================
// ëª¨ë“œ 2: íƒ­ ì˜¤ë””ì˜¤ + ë§ˆì´í¬ ìŠ¤í…Œë ˆì˜¤ ë¯¹ìŠ¤ â†’ ì„œë²„ Whisper
// ========================================
function getSupportedMimeType() {
  var types = ['audio/webm;codecs=opus', 'audio/webm', 'audio/ogg;codecs=opus', 'audio/mp4'];
  for (var i = 0; i < types.length; i++) {
    if (MediaRecorder.isTypeSupported(types[i])) return types[i];
  }
  return '';
}

async function startTabAudio() {
  if (activeMode) { toast('âš ï¸ ì´ë¯¸ ì¸ì‹ ì¤‘ì…ë‹ˆë‹¤'); return; }

  // 1) íƒ­ ì˜¤ë””ì˜¤ ìº¡ì²˜ (getDisplayMedia)
  try {
    tabDisplayStream = await navigator.mediaDevices.getDisplayMedia({ audio: true, video: true });
  } catch(e) {
    toast('âŒ íƒ­ ê³µìœ ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤');
    return;
  }

  // ë¹„ë””ì˜¤ íŠ¸ë™ ì œê±° (ì˜¤ë””ì˜¤ë§Œ í•„ìš”)
  tabDisplayStream.getVideoTracks().forEach(function(t) { t.stop(); });

  if (tabDisplayStream.getAudioTracks().length === 0) {
    toast('âŒ ì˜¤ë””ì˜¤ ì—†ìŒ â€” ê³µìœ  íŒì—…ì—ì„œ "íƒ­ ì˜¤ë””ì˜¤ë„ ê³µìœ "ë¥¼ ì²´í¬í•˜ì„¸ìš”');
    tabDisplayStream.getTracks().forEach(function(t) { t.stop(); });
    tabDisplayStream = null;
    return;
  }

  // 2) ë§ˆì´í¬ ìº¡ì²˜ (getUserMedia) â€” ì‹¤íŒ¨í•´ë„ íƒ­ ì˜¤ë””ì˜¤ë§Œìœ¼ë¡œ ì§„í–‰
  try {
    tabMicStream = await navigator.mediaDevices.getUserMedia({ audio: true });
  } catch(e) {
    toast('âš ï¸ ë§ˆì´í¬ ê¶Œí•œ ê±°ë¶€ â€” íƒ­ ì˜¤ë””ì˜¤ë§Œ ì¸ì‹í•©ë‹ˆë‹¤');
    tabMicStream = null;
  }

  // 3) AudioContextë¡œ ìŠ¤í…Œë ˆì˜¤ ë¯¹ìŠ¤
  tabAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
  var dest = tabAudioCtx.createMediaStreamDestination();

  var tabSource = tabAudioCtx.createMediaStreamSource(tabDisplayStream);
  tabSource.connect(dest);

  if (tabMicStream) {
    var micSource = tabAudioCtx.createMediaStreamSource(tabMicStream);
    micSource.connect(dest);
  }

  var mixedStream = dest.stream;

  // 4) ì„œë²„ WebSocket ì—°ê²° (audio_sender)
  var proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  audioSenderWs = new WebSocket(proto + '//' + location.host + '/ws?role=audio_sender');

  audioSenderWs.onopen = function() {
    setRunning('tab');
    toast('ğŸ–¥ï¸ íƒ­ ì˜¤ë””ì˜¤' + (tabMicStream ? ' + ë§ˆì´í¬' : '') + ' ì¸ì‹ ì‹œì‘!');
    startRecordingCycle(mixedStream);
  };

  audioSenderWs.onerror = function() {
    toast('âŒ ì„œë²„ WebSocket ì—°ê²° ì‹¤íŒ¨');
    stopTabAudio();
  };

  audioSenderWs.onclose = function() {
    if (activeMode === 'tab') {
      stopTabAudio();
      toast('âš ï¸ ì„œë²„ ì—°ê²°ì´ ëŠê²¼ìŠµë‹ˆë‹¤');
    }
  };

  // íƒ­ ê³µìœ  ì¤‘ë‹¨ ê°ì§€ (ì‚¬ìš©ìê°€ "ê³µìœ  ì¤‘ì§€" í´ë¦­)
  tabDisplayStream.getAudioTracks()[0].onended = function() {
    stopTabAudio();
    toast('â¹ íƒ­ ì˜¤ë””ì˜¤ ê³µìœ ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤');
  };

  document.getElementById('tabGoBtn').disabled = true;
  document.getElementById('tabStopBtn').disabled = false;
}

// 10ì´ˆë§ˆë‹¤ ë…¹ìŒ â†’ ì„œë²„ ì „ì†¡ ì‚¬ì´í´
function startRecordingCycle(stream) {
  if (activeMode !== 'tab') return;

  var mimeType = getSupportedMimeType();
  if (!mimeType) { toast('âŒ ì´ ë¸Œë¼ìš°ì €ëŠ” ì˜¤ë””ì˜¤ ë…¹ìŒì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤'); stopTabAudio(); return; }

  tabRecorder = new MediaRecorder(stream, { mimeType: mimeType });
  var chunks = [];

  tabRecorder.ondataavailable = function(e) {
    if (e.data.size > 0) chunks.push(e.data);
  };

  tabRecorder.onstop = function() {
    // ë…¹ìŒëœ ì˜¤ë””ì˜¤ë¥¼ ë°”ì´ë„ˆë¦¬ë¡œ ì„œë²„ì— ì „ì†¡
    if (chunks.length > 0 && audioSenderWs && audioSenderWs.readyState === WebSocket.OPEN) {
      var blob = new Blob(chunks, { type: mimeType });
      blob.arrayBuffer().then(function(buf) {
        audioSenderWs.send(buf);
      });
    }
    // ë‹¤ìŒ 10ì´ˆ ì‚¬ì´í´ ì‹œì‘
    if (activeMode === 'tab') {
      startRecordingCycle(stream);
    }
  };

  tabRecorder.start();

  setTimeout(function() {
    if (tabRecorder && tabRecorder.state === 'recording') {
      tabRecorder.stop();
    }
  }, 10000);
}

function stopTabAudio() {
  if (tabRecorder && tabRecorder.state === 'recording') {
    try { tabRecorder.stop(); } catch(e) {}
  }
  tabRecorder = null;

  if (tabDisplayStream) {
    tabDisplayStream.getTracks().forEach(function(t) { t.stop(); });
    tabDisplayStream = null;
  }
  if (tabMicStream) {
    tabMicStream.getTracks().forEach(function(t) { t.stop(); });
    tabMicStream = null;
  }
  if (tabAudioCtx) {
    try { tabAudioCtx.close(); } catch(e) {}
    tabAudioCtx = null;
  }
  if (audioSenderWs) {
    try { audioSenderWs.close(); } catch(e) {}
    audioSenderWs = null;
  }

  setRunning(null);
  document.getElementById('tabGoBtn').disabled = false;
  document.getElementById('tabStopBtn').disabled = true;
}

// ========================================
// ê³µí†µ: ì¸ì‹ ìƒíƒœ ê´€ë¦¬
// ========================================
function setRunning(mode) {
  activeMode = mode;
  var b = document.getElementById('badge'), bt = document.getElementById('badgeTx');
  var w = document.getElementById('wave');

  if (mode) {
    b.className = 'badge on';
    bt.textContent = mode === 'yt' ? 'YouTube ì¸ì‹ ì¤‘...' : 'íƒ­ ì˜¤ë””ì˜¤ ì¸ì‹ ì¤‘...';
    w.classList.add('on');
  } else {
    b.className = 'badge';
    bt.textContent = 'ëŒ€ê¸° ì¤‘';
    w.classList.remove('on');
    document.getElementById('ytGoBtn').disabled = false;
    document.getElementById('ytStopBtn').disabled = true;
    document.getElementById('tabGoBtn').disabled = false;
    document.getElementById('tabStopBtn').disabled = true;
  }
}

// ì„œë²„ ìƒíƒœ í´ë§ (YouTube ëª¨ë“œ ë™ê¸°í™”)
async function pollStatus() {
  try {
    var resp = await fetch('/api/status');
    var d = await resp.json();
    document.getElementById('sV').textContent = d.viewers || 0;
    // YouTube ëª¨ë“œ ìƒíƒœ ë™ê¸°í™”
    if (activeMode === 'yt' && !d.running) setRunning(null);
    if (!activeMode && d.running) setRunning('yt');
  } catch(e) {}
}

// ========================================
// ìë§‰ ìœ í‹¸ë¦¬í‹° (ë³µì‚¬, ì €ì¥, ì´ˆê¸°í™”)
// ========================================
function getAllLines() {
  var lines = document.querySelectorAll('.tx-line:not(.status)'), out = [];
  lines.forEach(function(l) {
    var t = l.querySelector('.tx-text');
    var tm = l.querySelector('.tx-time');
    if (t && !t.classList.contains('interim')) {
      out.push({ time: tm ? tm.textContent : '', text: t.textContent.trim() });
    }
  });
  return out;
}

function copyTx() {
  var r = getAllLines();
  if (!r.length) { toast('ë³µì‚¬í•  ë‚´ìš© ì—†ìŒ'); return; }
  var t = r.map(function(x) { return '[' + x.time + '] ' + x.text; }).join('\n');
  navigator.clipboard.writeText(t).then(function() { toast('ğŸ“‹ ë³µì‚¬ ì™„ë£Œ'); });
}

function dlTx() {
  var r = getAllLines();
  if (!r.length) { toast('ì €ì¥í•  ë‚´ìš© ì—†ìŒ'); return; }
  var t = 'LiveSTT\n' + new Date().toLocaleString('ko-KR') + '\n\n';
  r.forEach(function(x) { t += '[' + x.time + '] ' + x.text + '\n'; });
  var a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([t], { type: 'text/plain;charset=utf-8' }));
  a.download = 'livesst_' + new Date().toISOString().slice(0, 10) + '.txt';
  a.click();
  toast('ğŸ’¾ ì €ì¥ ì™„ë£Œ');
}

function clearTx() {
  document.getElementById('txBox').innerHTML = '<div class="empty" id="emptyEl"><div class="empty-ic">ğŸ¤</div><div class="empty-t">ì´ˆê¸°í™” ì™„ë£Œ</div><div class="empty-d">ì¸ì‹ ëª¨ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”</div></div>';
  nL = 0;
  document.getElementById('sL').textContent = 0;
  if (interimEl) { interimEl = null; }
  toast('ğŸ—‘ ì´ˆê¸°í™”');
}

// ========================================
// Ollama ë¯¸íŒ… ìš”ì•½
// ========================================
async function openSum() {
  var bd = document.getElementById('sumBody');
  var ov = document.getElementById('sumOv');
  var rows = getAllLines();
  var texts = rows.map(function(r) { return r.text; }).filter(function(t) { return t.length > 0; });

  if (texts.length < 3) {
    bd.innerHTML = '<div class="sum-empty"><span>ğŸ“</span>ìµœì†Œ 3ë¬¸ì¥ ì´ìƒ í•„ìš”í•©ë‹ˆë‹¤<br><small>í˜„ì¬ ' + texts.length + 'ë¬¸ì¥</small></div>';
    ov.classList.add('open');
    return;
  }

  // ë¡œë”© ìƒíƒœ í‘œì‹œ
  bd.innerHTML = '<div class="sum-loading"><div class="spinner"></div>Ollamaê°€ ë¯¸íŒ… ìš”ì•½ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...<br><small>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš” (ìµœëŒ€ 90ì´ˆ)</small></div>';
  ov.classList.add('open');

  try {
    var resp = await fetch('/api/summary', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ lines: texts })
    });
    var data = await resp.json();

    if (!resp.ok) {
      bd.innerHTML = '<div class="sum-error">âŒ ' + esc(data.error || 'ìš”ì•½ ìƒì„± ì‹¤íŒ¨') + '</div>';
      return;
    }

    sumCache = data.summary || '';
    bd.innerHTML = renderMarkdown(sumCache);
  } catch(e) {
    bd.innerHTML = '<div class="sum-error">âŒ ì„œë²„ ì—°ê²° ì‹¤íŒ¨: ' + esc(e.message) + '</div>';
  }
}

// ê°„ë‹¨í•œ ë§ˆí¬ë‹¤ìš´ â†’ HTML ë³€í™˜
function renderMarkdown(text) {
  var html = text
    .replace(/^### (.+)$/gm, '<h3>$1</h3>')
    .replace(/^## (.+)$/gm, '<h3>$1</h3>')
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/^- (.+)$/gm, '<li>$1</li>')
    .replace(/\n\n/g, '\n<br>\n');
  // li ì—°ì†ì„ ulë¡œ ê°ì‹¸ê¸°
  html = html.replace(/((?:<li>.*<\/li>\n?)+)/g, '<ul>$1</ul>');
  html = html.replace(/\n/g, '');
  return html;
}

function closeSum() { document.getElementById('sumOv').classList.remove('open'); }
function copySum() {
  if (!sumCache) { toast('ë³µì‚¬í•  ìš”ì•½ ì—†ìŒ'); return; }
  navigator.clipboard.writeText(sumCache).then(function() { toast('ğŸ“‹ ìš”ì•½ ë³µì‚¬ ì™„ë£Œ'); });
}

// ========================================
// í† ìŠ¤íŠ¸ ë©”ì‹œì§€
// ========================================
var tt;
function toast(m) {
  var e = document.getElementById('toast');
  e.textContent = m; e.classList.add('show');
  if (tt) clearTimeout(tt);
  tt = setTimeout(function() { e.classList.remove('show'); }, 3000);
}
</script>
</body>
</html>
